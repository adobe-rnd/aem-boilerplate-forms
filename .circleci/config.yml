version: 2.1

orbs:
  node: circleci/node@5.0.3

jobs:
  lint:
    docker:
      - image: cimg/node:20.9
    steps:
      - checkout

      # ---------- Restore NPM cache ----------
      - restore_cache:
          keys:
            - v1-npm-cache-{{ checksum "package-lock.json" }}

      - run:
          name: Install dependencies
          command: npm ci

      - save_cache:
          key: v1-npm-cache-{{ checksum "package-lock.json" }}
          paths:
            - ~/.npm

      - run:
          name: Run linter
          command: npm run lint

      - persist_to_workspace:
          root: .
          paths:
            - .

  unit-tests:
    docker:
      - image: cimg/node:20.9
    steps:
      - checkout

      # ---------- Restore NPM cache ----------
      - restore_cache:
          keys:
            - v1-npm-cache-{{ checksum "package-lock.json" }}

      - run:
          name: Install dependencies
          command: npm ci

      - save_cache:
          key: v1-npm-cache-{{ checksum "package-lock.json" }}
          paths:
            - ~/.npm

      - run:
          name: Run unit tests with coverage
          command: |
            npx c8 --reporter=json --reporter=text --lines 45 \
              npm run test:unit || true

      - persist_to_workspace:
          root: .
          paths:
            - coverage

  e2e-tests:
    docker:
      - image: mcr.microsoft.com/playwright:v1.40.0-jammy
    steps:
      - checkout

      # ---------- Restore NPM cache ----------
      - restore_cache:
          keys:
            - v1-npm-cache-{{ checksum "package-lock.json" }}

      - run:
          name: Install dependencies
          command: npm ci

      - save_cache:
          key: v1-npm-cache-{{ checksum "package-lock.json" }}
          paths:
            - ~/.npm

      # NO playwright browser install here → already included → MUCH faster

      - run:
          name: Run E2E tests with coverage
          command: |
            npx c8 --reporter=json --reporter=text --lines 45 \
              npx playwright test --project='chromium' --reporter=line || true

            if [ -f "coverage/coverage-final.json" ]; then
              mv coverage/coverage-final.json coverage/coverage-final-e2e.json

              mkdir -p .nyc_output coverage/e2e-artifacts
              cp coverage/coverage-final-e2e.json .nyc_output/coverage.json
              npx nyc report --reporter=html --report-dir=coverage/e2e-artifacts
              npx nyc report --reporter=text-summary > coverage/e2e-artifacts/e2e-text-summary.txt
              cp coverage/e2e-artifacts/index.html coverage/e2e-artifacts/indexE2e.html
            else
              mkdir -p coverage
              echo '{}' > coverage/coverage-final-e2e.json
            fi
        environment:
          CI: "true"
          COVERAGE_RUN: "true"
          PWTEST_DISABLE_V8_COMPILE_CACHE: "1"

      # ---------- Test artifacts ----------
      - store_artifacts:
          path: test/e2e/reports
          destination: test-results

      - store_artifacts:
          path: videos
          destination: videos

      - store_artifacts:
          path: test-results
          destination: screenshots

      # ---------- Persist E2E coverage ----------
      - persist_to_workspace:
          root: .
          paths:
            - coverage/coverage-final-e2e.json

  merge-coverage:
    docker:
      - image: cimg/node:20.9
    steps:
      - checkout
      - attach_workspace:
          at: .

      # ---------- Restore NPM cache ----------
      - restore_cache:
          keys:
            - v1-npm-cache-{{ checksum "package-lock.json" }}

      - run:
          name: Install dependencies
          command: npm ci

      - save_cache:
          key: v1-npm-cache-{{ checksum "package-lock.json" }}
          paths:
            - ~/.npm

      - run:
          name: Merge coverage from Unit + E2E
          command: |
            mkdir -p .nyc_output

            cp coverage/coverage-final.json .nyc_output/coverage-unit.json
            cp coverage/coverage-final-e2e.json .nyc_output/coverage-e2e.json

            npx nyc merge .nyc_output coverage/merged-coverage.json

            cp coverage/merged-coverage.json .nyc_output/coverage.json
            npx nyc report --reporter=html --report-dir=coverage/merged-report
            npx nyc report --reporter=text-summary > coverage/merged-report/summary.txt

      - store_artifacts:
          path: coverage/merged-report
          destination: merged-coverage

workflows:
  version: 2
  build_and_test:
    jobs:
      - lint
      - unit-tests:
          requires:
            - lint
      - e2e-tests:
          requires:
            - lint
      - merge-coverage:
          requires:
            - unit-tests
            - e2e-tests
