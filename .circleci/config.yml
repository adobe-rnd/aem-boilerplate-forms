version: 2.1

orbs:
  node: circleci/node@5
  browser-tools: circleci/browser-tools@1.2.3

# ---------------- JOB DEFINITIONS ----------------
jobs:
  # ---------------- LINT JOB ----------------
  lint:
    executor: node/default
    steps:
      - checkout
      - node/install-packages:
          pkg-manager: npm
      - run:
          name: Run lint
          command: npm run lint

  # ---------------- UNIT TEST JOB ----------------
  unit-tests:
    executor: node/default
    steps:
      - checkout
      - node/install-packages:
          pkg-manager: npm

      # Helpful install error instructions
      - run:
          name: Print node install help instructions
          command: |-
            echo "One cause for node package install failure is if you have private repositories that it can't reach
            One way to fix this for private npm packages:
              1. Use the npm CLI's \"login\" command to create a token (usually saved in your user's \"~/.npmrc\" file)
              2. Add a NPM_TOKEN to an org context
              3. Configure jobs to use the context with NPM_TOKEN
              4. Inject NPM_TOKEN before install-packages"
          when: on_fail

      - run:
          name: Run unit tests with coverage
          command: npm run coverage:unit
          environment:
            CI: true

      # Ensure coverage directories exist before persisting
      - run:
          name: Ensure coverage directories exist
          command: |
            mkdir -p .nyc_output/unit

      # Persist coverage results for later merge
      - persist_to_workspace:
          root: .
          paths:
            - .nyc_output/unit

  # ---------------- E2E TEST JOB ----------------
  e2e-tests:
    docker:
      - image: mcr.microsoft.com/playwright:v1.40.0-jammy
    steps:
      - checkout

      # Install Node.js and dependencies
      - run:
          name: Install dependencies
          command: npm ci

      # Install Playwright browsers
      - run:
          name: Install Playwright browsers
          command: npx playwright install chromium

      - run:
          name: Run e2e tests with coverage
          command: npm run coverage:e2e
          environment:
            CI: true
            COVERAGE_RUN: true

      # Store artifacts for debugging
      - store_artifacts:
          path: test/e2e/reports
          destination: test-results
      - store_artifacts:
          path: ./videos
          destination: videos
      - store_artifacts:
          path: ./error-screenshot.png
          destination: screenshots

      # Ensure coverage directories exist before persisting
      - run:
          name: Ensure coverage directories exist
          command: |
            mkdir -p .nyc_output/e2e

      # Persist coverage results for merge step
      - persist_to_workspace:
          root: .
          paths:
            - .nyc_output/e2e

  # ---------------- MERGE + REPORT COVERAGE ----------------
  check-coverage:
    executor: node/default
    steps:
      - checkout
      - node/install-packages:
          pkg-manager: npm
      - attach_workspace:
          at: .
      - run:
          name: Debug coverage files
          command: |
            echo "ðŸ” Checking what coverage files we have..."
            ls -la .nyc_output/unit/ || echo "No unit coverage files"
            ls -la .nyc_output/e2e/ || echo "No e2e coverage files"
      - run:
          name: Merge and generate final coverage
          command: |
            set -e
            echo "ðŸ”¹ Merging unit coverage..."
            mkdir -p .nyc_output/merged
            npx nyc merge .nyc_output/unit > .nyc_output/merged/unit.json

            echo "ðŸ”¹ Merging e2e coverage..."
            npx nyc merge .nyc_output/e2e > .nyc_output/merged/e2e.json

            echo "ðŸ”¹ Merging unit + e2e into final coverage..."
            npx nyc merge .nyc_output/merged > .nyc_output/merged/coverage.json

            echo "ðŸ”¹ Generating final reports (text-summary, lcov, html)..."
            npx nyc report \
              --temp-dir .nyc_output/merged \
              --reporter=text-summary \
              --reporter=lcov \
              --reporter=html

            echo "ðŸ”¹ Enforcing minimum coverage thresholds..."
            npx nyc check-coverage --lines=90 --branches=90 --functions=90 --statements=90

            echo "âœ… Combined coverage report successfully generated and validated!"
      - store_artifacts:
          path: coverage
          destination: merged-coverage

# ---------------- WORKFLOWS ----------------
workflows:
  lint:
    jobs:
      - lint
  build-and-test:
    jobs:
      - unit-tests
      - e2e-tests
      - check-coverage:
          requires:
            - unit-tests
            - e2e-tests
